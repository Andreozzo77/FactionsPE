<?php
/*
 *   FactionsPE: PocketMine-MP Plugin
 *   Copyright (C) 2020 BlockHorizons
 */

namespace BlockHorizons\FactionsPE\engine;

use BlockHorizons\FactionsPE\utils\Gameplay;
use pocketmine\block\Block;
use pocketmine\block\Liquid;
use pocketmine\entity\object\PrimedTNT;
use pocketmine\event\entity\EntityExplodeEvent;

class ExploitEngine extends Engine
{

    /** @var Block */
    private $air;

    public function setup()
    {
        $this->air = Block::get(0);
    }

    /**
     * Allows obsidian to explode
     *
     * @param EntityExplodeEvent $event
     * @priority MONITOR
     * @ignoreCancelled false
     */
    public function explodeInWater(EntityExplodeEvent $event)
    {
        $entity = $event->getEntity();
        if (!$entity instanceof PrimedTNT) return;
        $center = $entity->getLevel()->getBlock($entity);
        if (!$center instanceof Liquid) return;
        if (!Gameplay::get('handle-exploit-tnt-water-log', true)) return;
        $targets = [];
        for ($i = 0; $i <= 6; $i++) {
            $targets[] = $center->getSide($i);
        }
        foreach ($targets as $target) {
            $id = $target->getId();
            if ($id != 0 && ($id < 7 || $id > 11) && $id != 49 && $id != 90 && $id != 116 && $id != 119 && $id != 120 && $id != 130) {
                // Break
                $target->getLevel()->setBlock($target, $this->air);
            }
        }
    }

    public function explosion(EntityExplodeEvent $event)
    {
        $entity = $event->getEntity();
        if (!$entity instanceof PrimedTNT) return;
        $center = $entity->getLevel()->getBlock($entity);
        $targets = [];
        for ($i = 0; $i <= 6; $i++) {
            $targets[] = $center->getSide($i);
        }
        foreach ($targets as $target) {
            if ($target->getId() === Block::OBSIDIAN) $target->getLevel()->setBlock($target, $this->air);
        }
    }

}